name: Build + Release

on:
  repository_dispatch:
    types: [build-release]

jobs:
  build:
    name: Build artifacts
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        goos: [linux, windows, darwin, freebsd]
        goarch: [amd64, arm64, 386]
        include:
          - goos: linux
            goarch: 386
          - goos: linux
            goarch: s390x
          - goos: linux
            goarch: riscv64
          - goos: linux
            goarch: arm
          - goos: linux
            goarch: mips
            gomips: softfloat
          - goos: linux
            goarch: mipsle
            gomips: softfloat
          - goos: linux
            goarch: loong64
          - goos: freebsd
            goarch: arm
        exclude:
          - goos: darwin
            goarch: 386

    steps:
<<<<<<< HEAD
      - uses: actions/checkout@v3
        with:
          repository: ${{secrets.PRIVATE_REPO}}
          ref: ${{secrets.PRIVATE_REPO_REF}}
          token: ${{secrets.PRIVATE_REPO_TOKEN}}
=======
      - name: Read tag from webhook
        run: |
          echo "TAG_FROM_A=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
          echo "Using tag: ${{ github.event.client_payload.tag }}"

      - name: Checkout private repo (A repo by tag)
        run: |
          rm -rf ./*
          git clone --branch "$TAG_FROM_A" --single-branch \
            https://${{ secrets.PRIVATE_REPO_TOKEN }}@${{ secrets.PRIVATE_REPO }} .
>>>>>>> main

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.2

      - name: Build
        uses: goreleaser/goreleaser-action@v6
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips }}
        with:
          distribution: goreleaser
          version: "~> v2"
          args: build --single-target --clean --skip=validate

      - name: Archive
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist/zips
          zip -jr dist/zips/nezha-agent_${GOOS}_${GOARCH}.zip dist/*/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent_${{ matrix.goos }}_${{ matrix.goarch }}
          path: dist/zips/*.zip

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
<<<<<<< HEAD
    name: Release

    permissions:
      contents: write
=======

    permissions:
      contents: write

>>>>>>> main
    steps:
      - name: Read tag from webhook
        run: echo "TAG_FROM_A=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./assets

      - name: Checksum
        run: |
          find ./assets -name "*.zip" -exec sha256sum {} \; \
            | awk -F" |/" '{print $1, $NF}' > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_FROM_A }}
          files: |
            checksums.txt
<<<<<<< HEAD
            assets/*/*.zip
          generate_release_notes: false
=======
            assets/**/*.zip
          generate_release_notes: false
>>>>>>> main
